<mat-card class="new-slot-card">
  <mat-card-header>
    <mat-card-title>Create a new time slot</mat-card-title>
    <mat-card-subtitle>
      Add availability for an event category.
    </mat-card-subtitle>
  </mat-card-header>

  <form [formGroup]="newSlotForm" (ngSubmit)="onCreateSlot()">
    <mat-card-content class="slot-form-grid">
      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select formControlName="categoryId" required>
          <mat-option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="newSlotForm.controls.categoryId.hasError('required')">
          Select a category.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Date</mat-label>
        <input
          matInput
          type="date"
          formControlName="date"
          required
        />
        <mat-error *ngIf="newSlotForm.controls.date.hasError('required')">
          Choose a date.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Start time</mat-label>
        <input
          matInput
          type="time"
          formControlName="startTime"
          required
        />
        <mat-error *ngIf="newSlotForm.controls.startTime.hasError('required')">
          Provide a start time.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End time</mat-label>
        <input
          matInput
          type="time"
          formControlName="endTime"
          required
        />
        <mat-error *ngIf="newSlotForm.controls.endTime.hasError('required')">
          Provide an end time.
        </mat-error>
      </mat-form-field>
    </mat-card-content>

    <mat-card-actions align="end">
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="newSlotForm.invalid || isCreatingSlot"
      >
        <mat-icon aria-hidden="true">add</mat-icon>
        Create slot
        <mat-progress-spinner
          *ngIf="isCreatingSlot"
          diameter="16"
          mode="indeterminate"
        ></mat-progress-spinner>
      </button>
    </mat-card-actions>
  </form>
</mat-card>

<section class="timeslot-toolbar">
  <div class="week-controls">
    <button
      mat-icon-button
      (click)="changeWeek(-1)"
      aria-label="Previous week"
    >
      <mat-icon>chevron_left</mat-icon>
    </button>
    <div class="week-label">{{ weekRangeLabel }}</div>
    <button
      mat-icon-button
      (click)="changeWeek(1)"
      aria-label="Next week"
    >
      <mat-icon>chevron_right</mat-icon>
    </button>
    <button
      mat-stroked-button
      type="button"
      (click)="goToCurrentWeek()"
    >
      This week
    </button>
  </div>

  <mat-form-field appearance="outline" class="category-filter">
    <mat-label>Filter by category</mat-label>
    <mat-select
      [value]="categoryFilter"
      (valueChange)="applyCategoryFilter($event)"
    >
      <mat-option value="all">All categories</mat-option>
      <mat-option
        *ngFor="let category of categories"
        [value]="category.id"
      >
        {{ category.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>
</section>

<section class="timeslot-table-wrapper">
  <ng-container *ngIf="!isLoadingSlots; else loadingSlots">
    <table mat-table [dataSource]="filteredSlots" class="timeslot-table">
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let slot">
          {{ formatDate(slot.startDate) }}
        </td>
      </ng-container>

      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef>Time</th>
        <td mat-cell *matCellDef="let slot">
          {{ formatTimeRange(slot) }}
        </td>
      </ng-container>

      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Category</th>
        <td mat-cell *matCellDef="let slot">
          {{ slot.category.name }}
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let slot">
          <mat-chip
            [color]="slot.booking ? 'warn' : 'primary'"
            [selected]="true"
            variant="filled"
          >
            {{ slot.booking ? 'Booked' : 'Available' }}
          </mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="booking">
        <th mat-header-cell *matHeaderCellDef>Booking details</th>
        <td mat-cell *matCellDef="let slot">
          <ng-container *ngIf="slot.booking; else unassigned">
            <div class="booking-details">
              <span class="booking-name">{{ slot.booking.user_name }}</span>
              <span class="booking-email">{{ slot.booking.user_email }}</span>
            </div>
          </ng-container>
          <ng-template #unassigned>
            <span class="booking-empty">—</span>
          </ng-template>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <div class="empty-state" *ngIf="filteredSlots.length === 0">
      No time slots found for the selected filters.
    </div>
  </ng-container>
</section>

<ng-template #loadingSlots>
  <div class="loading-panel">
    <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
    <span>Loading time slots…</span>
  </div>
</ng-template>
